_format_version: "3.0"

plugins:
  - name: cors
    tags: [cors-default]
    config:
      origins: ["http://localhost:5173"]
      methods: [GET, POST, PUT, DELETE, OPTIONS]
      headers: [Accept, Content-Type, Authorization, X-User-Name, X-User-Role]
      exposed_headers: [Authorization]
      credentials: true
      max_age: 3600

services:
  - name: auth-service
    url: http://auth:8080
    routes:
      - name: auth-route
        paths: ["/auth"]
        strip_path: true
    tags: [cors-default]

  - name: upload-service
    url: http://upload:6565
    routes:
      - name: upload-route
        paths: ["/upload"]
        strip_path: false
    tags: [cors-default]
    plugins:
      - name: http-proxy
        config:
          upstream_url: http://auth:8080/kong-validate
          forward_request_body: false
          forward_request_headers: ["Cookie"]
      - name: request-transformer
        config:
          add:
            headers:
              - "X-User-Name:$(headers['X-User-Name'])"
              - "X-User-Role:$(headers['X-User-Role'])"

  - name: download-service
    url: http://download:8012
    routes:
      - name: download-route
        paths: ["/download"]
        strip_path: false
    tags: [cors-default]
    plugins:
      - name: http-proxy
        config:
          upstream_url: http://auth:8080/kong-validate
          forward_request_body: false
          forward_request_headers: ["Cookie"]
      - name: request-transformer
        config:
          add:
            headers:
              - "X-User-Name:$(headers['X-User-Name'])"
              - "X-User-Role:$(headers['X-User-Role'])"
